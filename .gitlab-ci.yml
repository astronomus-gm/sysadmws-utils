# We excplicitly use tag with runner hostname to ensure stages on the same runner.
# This brakes parallelism but makes things much clearer and simplier.

stages:
- make_deb
- make_tgz
- add_repo_deb

cache:
  paths:
    - builds

make_deb_v0:
  tags:
    - dev1.sysadm.ws
  stage: make_deb
  artifacts:
    name: deb_v0
    paths:
      - builds/v0/deb/sysadmws-utils.deb
  only:
    refs:
      - v0
  script: |
    # Create dir for every util
    mkdir -p builds/v0/deb/sysadmws-utils/etc/cron.d \
             builds/v0/deb/sysadmws-utils/etc/logrotate.d \
             builds/v0/deb/sysadmws-utils/opt/sysadmws-utils/bulk_log \
             builds/v0/deb/sysadmws-utils/opt/sysadmws-utils/mysql_queries_log \
             builds/v0/deb/sysadmws-utils/opt/sysadmws-utils/mysql_replica_checker \
             builds/v0/deb/sysadmws-utils/opt/sysadmws-utils/notify_devilry \
             builds/v0/deb/sysadmws-utils/opt/sysadmws-utils/disk_alert \
             builds/v0/deb/sysadmws-utils/opt/sysadmws-utils/put_check_files \
             builds/v0/deb/sysadmws-utils/opt/sysadmws-utils/logrotate_db_backup \
             builds/v0/deb/sysadmws-utils/opt/sysadmws-utils/mikrotik_backup \
             builds/v0/deb/sysadmws-utils/opt/sysadmws-utils/rsnapshot_backup \
             builds/v0/deb/sysadmws-utils/opt/sysadmws-utils/backup_check \
             builds/v0/deb/sysadmws-utils/opt/sysadmws-utils/misc \
             builds/v0/deb/sysadmws-utils/opt/sysadmws-utils/salt
    # LICENSE utils_readme.md
    cp LICENSE \
       README.md \
       builds/v0/deb/sysadmws-utils/opt/sysadmws-utils
    # bulk_log
    cp bulk_log/bulk_log.sh \
       builds/v0/deb/sysadmws-utils/opt/sysadmws-utils/bulk_log
    cp bulk_log/bulk_log.cron \
       builds/v0/deb/sysadmws-utils/etc/cron.d/sysadmws-bulk-log
    chmod 600 builds/v0/deb/sysadmws-utils/etc/cron.d/sysadmws-bulk-log
    cp bulk_log/bulk_log.logrotate \
       builds/v0/deb/sysadmws-utils/etc/logrotate.d/sysadmws-bulk-log
    chmod 600 builds/v0/deb/sysadmws-utils/etc/logrotate.d/sysadmws-bulk-log
    # mysql_queries_log
    cp mysql_queries_log/mysql_queries_log.sh \
       builds/v0/deb/sysadmws-utils/opt/sysadmws-utils/mysql_queries_log
    cp mysql_queries_log/mysql_queries_log.cron \
       builds/v0/deb/sysadmws-utils/etc/cron.d/sysadmws-mysql-queries-log
    chmod 600 builds/v0/deb/sysadmws-utils/etc/cron.d/sysadmws-mysql-queries-log
    cp mysql_queries_log/mysql_queries_log.logrotate \
       builds/v0/deb/sysadmws-utils/etc/logrotate.d/sysadmws-mysql-queries-log
    chmod 600 builds/v0/deb/sysadmws-utils/etc/logrotate.d/sysadmws-mysql-queries-log
    # mysql_replica_checker
    cp mysql_replica_checker/mysql_replica_checker.sh \
       mysql_replica_checker/mysql_replica_checker.conf.sample \
       builds/v0/deb/sysadmws-utils/opt/sysadmws-utils/mysql_replica_checker
    cp mysql_replica_checker/mysql_replica_checker.cron \
       builds/v0/deb/sysadmws-utils/etc/cron.d/sysadmws-mysql-replica-checker
    chmod 600 builds/v0/deb/sysadmws-utils/etc/cron.d/sysadmws-mysql-replica-checker
    # notify_devilry
    cp notify_devilry/notify_devilry.py \
       notify_devilry/notify_devilry_test.sh \
       notify_devilry/notify_devilry.yaml.jinja.example \
       notify_devilry/notify_devilry.yaml.jinja.shortex \
       builds/v0/deb/sysadmws-utils/opt/sysadmws-utils/notify_devilry
    # disk_alert
    cp disk_alert/disk_alert.sh \
       disk_alert/disk_alert.conf \
       disk_alert/lr.awk \
       builds/v0/deb/sysadmws-utils/opt/sysadmws-utils/disk_alert
    cp disk_alert/disk_alert.cron \
       builds/v0/deb/sysadmws-utils/etc/cron.d/sysadmws-disk-alert
    chmod 600 builds/v0/deb/sysadmws-utils/etc/cron.d/sysadmws-disk-alert
    # put_check_files
    cp put_check_files/put_check_files.sh \
       put_check_files/put_check_files.conf.sample \
       builds/v0/deb/sysadmws-utils/opt/sysadmws-utils/put_check_files
    cp put_check_files/put_check_files.cron \
       builds/v0/deb/sysadmws-utils/etc/cron.d/sysadmws-put-check-files
    chmod 600 builds/v0/deb/sysadmws-utils/etc/cron.d/sysadmws-put-check-files
    # logrotate_db_backup
    cp logrotate_db_backup/logrotate_db_backup.awk \
       logrotate_db_backup/logrotate_db_backup.conf.sample \
       logrotate_db_backup/logrotate_db_backup.sh \
       builds/v0/deb/sysadmws-utils/opt/sysadmws-utils/logrotate_db_backup
    # mikrotik_backup
    cp mikrotik_backup/mikrotik_backup.sh \
       mikrotik_backup/mikrotik_backup.conf.sample \
       builds/v0/deb/sysadmws-utils/opt/sysadmws-utils/mikrotik_backup
    # rsnapshot_backup
    cp rsnapshot_backup/rsnapshot_backup.awk \
       rsnapshot_backup/rsnapshot_backup.sh \
       rsnapshot_backup.conf.localhost \
       rsnapshot_backup.conf.sample \
       rsnapshot_backup.conf_centos.sh \
       rsnapshot_backup.conf_debian.sh \
       rsnapshot_backup.conf_mysql.sh \
       rsnapshot_backup.conf_path.sh \
       rsnapshot_backup.conf_postgresql.sh \
       rsnapshot_backup.conf_ubuntu.sh \
       rsnapshot_backup/rsnapshot_conf_template_FS_RSYNC_SSH_PATH.conf \
       rsnapshot_backup/rsnapshot_conf_template_FS_RSYNC_SSH_UBUNTU.conf \
       rsnapshot_backup/rsnapshot_conf_template_FS_RSYNC_SSH_DEBIAN.conf \
       rsnapshot_backup/rsnapshot_conf_template_FS_RSYNC_SSH_CENTOS.conf \
       rsnapshot_backup/rsnapshot_conf_template_ROTATE.conf \
       rsnapshot_backup/rsnapshot_conf_template_FS_RSYNC_NATIVE.conf \
       rsnapshot_backup/rsnapshot_conf_template_LOCAL_PREEXEC.conf \
       rsnapshot_backup/rsnapshot_backup_daily.cron \
       rsnapshot_backup/rsnapshot_backup_hourly.cron \
       rsnapshot_backup/rsnapshot_backup_postgresql_query1.sql \
       builds/v0/deb/sysadmws-utils/opt/sysadmws-utils/rsnapshot_backup
    cp rsnapshot_backup/rsnapshot_backup.logrotate \
       builds/v0/deb/sysadmws-utils/etc/logrotate.d/sysadmws-rsnapshot-backup
    chmod 600 builds/v0/deb/sysadmws-utils/etc/logrotate.d/sysadmws-rsnapshot-backup
    # backup_check
    cp backup_check/backup_check.sh \
       backup_check/by_check_file.awk \
       backup_check/by_check_file.sh \
       backup_check/by_fresh_files.awk \
       backup_check/by_fresh_files.sh \
       backup_check/by_mysql.awk \
       backup_check/by_mysql.sh \
       backup_check/by_postgresql.awk \
       backup_check/by_postgresql.sh \
       backup_check/compare_rsnapshot_backup_with_backup_check.awk \
       backup_check/compare_rsnapshot_backup_with_backup_check.sh \
       backup_check/check_rsnapshot_backup_no_compress_files.sh \
       builds/v0/deb/sysadmws-utils/opt/sysadmws-utils/backup_check
    # misc
    cp misc/mysql_dump_all_dbs_to_files.sh \
       misc/postgresql_dump_all_dbs_to_files.sh \
       misc/mysql_table_extractor.sh \
       misc/mysql_create_new_database.sh \
       builds/v0/deb/sysadmws-utils/opt/sysadmws-utils/misc
    # salt
    cp salt/*.template \
       builds/v0/deb/sysadmws-utils/opt/sysadmws-utils/salt
    # Make control dir
    mkdir -p builds/v0/deb/sysadmws-utils/DEBIAN
    # Make md5sums
    ( cd builds/v0/deb/sysadmws-utils && find . -type f ! -regex '.*?debian-binary.*' ! -regex '.*?DEBIAN.*' -printf '%P ' | xargs md5sum > DEBIAN/md5sums )
    # Get size
    export SIZE=$(du -s builds/v0/deb/sysadmws-utils | awk '{print $1}')
    # Get current and new version
    CUR_VERSION=$(curl -s https://repo.sysadm.ws/sysadmws-apt/dists/any/main/binary-amd64/Packages | grep -Pzo 'Package: sysadmws-utils\n.*\n.*\n.*\n.*\n' | grep --text 'Version' | sed -e 's/Version: 0\.//')
    export NEW_VERSION=$((CUR_VERSION+1))
    # Prepare control
    cat deb/control | sed -e "s#__VERSION__#$NEW_VERSION#" -e "s#__SIZE__#$SIZE#" > builds/v0/deb/sysadmws-utils/DEBIAN/control
    # Make deb
    ( cd builds/v0/deb && fakeroot dpkg-deb -b sysadmws-utils )

make_tgz_v0:
  tags:
    - dev1.sysadm.ws
  stage: make_tgz
  artifacts:
    name: tgz_v0
    paths:
      - builds/v0/tgz/sysadmws-utils.tar.gz
  only:
    refs:
      - v0
  script: |
    mkdir -p builds/v0/tgz
    cd builds/v0/tgz
    rm -rf sysadmws-utils
    cp -R ../deb/sysadmws-utils .
    cat sysadmws-utils/DEBIAN/control | grep Version > sysadmws-utils/opt/sysadmws-utils/VERSION
    rm -rf sysadmws-utils/DEBIAN
    fakeroot tar zcf sysadmws-utils.tar.gz -C sysadmws-utils .
    rm -rf sysadmws-utils

add_repo_deb_v0:
  tags:
    - dev1.sysadm.ws
  stage: add_repo_deb
  only:
    refs:
      - v0
  script: |
    export GNUPGHOME=/opt/sysadmws/gnupg/.gnupg
    killall gpg-agent; gpg-agent --daemon --allow-preset-passphrase
    sleep 3
    /usr/lib/gnupg2/gpg-preset-passphrase -v -c --preset -P $GPG_PASS E5337B7B1B6C8A420A48AB069BA912449F148CFB
    /usr/lib/gnupg2/gpg-preset-passphrase -v -c --preset -P $GPG_PASS 846876C563DD34B899FCD3C61F7C554D9AEDE1C2
    reprepro -v --basedir /opt/sysadmws/apt --gnupghome /opt/sysadmws/gnupg/.gnupg remove any sysadmws-utils
    reprepro -v --basedir /opt/sysadmws/apt --gnupghome /opt/sysadmws/gnupg/.gnupg includedeb any builds/v0/deb/sysadmws-utils.deb
